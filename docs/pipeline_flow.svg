<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="720" viewBox="0 0 1200 720">
  <style>
    .box { fill:#f7fbff; stroke:#2b6b9a; stroke-width:2; rx:6; }
    .box-strong { fill:#e6f0fa; stroke:#1f4f73; stroke-width:2.5; rx:8; }
    .text { font-family: Arial, Helvetica, sans-serif; font-size:13px; fill:#07203a }
    .title { font-size:16px; font-weight:700 }
    .arrow { stroke:#2b6b9a; stroke-width:2; fill:none; marker-end: url(#arrowhead); }
  </style>

  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#2b6b9a" />
    </marker>
  </defs>

  <rect x="20" y="18" width="1160" height="44" rx="6" fill="#073d5a" />
  <text x="40" y="48" class="text title" fill="#ffffff">ThePipeline3 — high-level flow</text>

  <!-- FastClean -->
  <g transform="translate(60,100)">
    <rect class="box-strong" x="0" y="0" width="220" height="70" />
    <text x="12" y="24" class="text" style="font-weight:700">fastclean</text>
    <text x="12" y="44" class="text">fastp → {prefix}.P1.clean.fastq.gz</text>
  </g>

  <!-- Kraken -->
  <g transform="translate(340,100)">
    <rect class="box-strong" x="0" y="0" width="260" height="90" />
    <text x="12" y="24" class="text" style="font-weight:700">kraken</text>
    <text x="12" y="44" class="text">classification → {prefix}.kraken</text>
    <text x="12" y="62" class="text">filtered reads → {prefix}.P1.filtered.fastq.gz</text>
  </g>

  <!-- Mapping -->
  <g transform="translate(660,90)">
    <rect class="box-strong" x="0" y="0" width="300" height="110" />
    <text x="12" y="24" class="text" style="font-weight:700">mapping</text>
    <text x="12" y="44" class="text">bwa mem → {prefix}.sort.bam / .sort.cram</text>
    <text x="12" y="64" class="text">Picard MarkDuplicates → {prefix}.dup.metrix</text>
    <text x="12" y="84" class="text">Qualimap, indexing</text>
  </g>

  <!-- Arrows between modules -->
  <path class="arrow" d="M280 135 L340 135" />
  <path class="arrow" d="M600 135 L660 135" />

  <!-- Calling -->
  <g transform="translate(120,250)">
    <rect class="box" x="0" y="0" width="980" height="170" />
    <text x="12" y="24" class="text" style="font-weight:700">calling (VarScan → Mutect2 → Minos → SnpEff)</text>
    <text x="12" y="48" class="text">Produces: {prefix}.DR.snp.final, {prefix}.EPI.snp.final.annoF, {prefix}.snp.minos, {prefix}.wt, {prefix}.lowcov</text>
    <text x="12" y="72" class="text">Temporary/intermediate files: {prefix}_mapq60.sort.bam, {prefix}.mpileup.remove,</text>
    <text x="12" y="92" class="text">{prefix}.gvcf, {prefix}.remade.snp.vcf, {prefix}_minos/ etc. (most removed at the end)</text>
    <text x="12" y="122" class="text">Minos runs in Singularity (container). GATK Mutect2 used for VCF/gVCF generation.</text>
  </g>

  <!-- From mapping to calling -->
  <path class="arrow" d="M820 150 L820 250" />
  <path class="arrow" d="M820 250 L180 250" />

  <!-- Consensus / Downstream modules -->
  <g transform="translate(140,450)">
    <rect class="box" x="0" y="0" width="220" height="80" />
    <text x="12" y="28" class="text" style="font-weight:700">consensus</text>
    <text x="12" y="48" class="text">produces multifasta & SNP table</text>
  </g>

  <g transform="translate(420,450)">
    <rect class="box" x="0" y="0" width="220" height="80" />
    <text x="12" y="28" class="text" style="font-weight:700">resistance</text>
    <text x="12" y="48" class="text">reads {prefix}.DR.snp.final → {prefix}.res</text>
  </g>

  <g transform="translate(700,450)">
    <rect class="box" x="0" y="0" width="260" height="80" />
    <text x="12" y="28" class="text" style="font-weight:700">multiqc / organize</text>
    <text x="12" y="48" class="text">collect reports, tidy outputs</text>
  </g>

  <path class="arrow" d="M620 320 L260 450" />
  <path class="arrow" d="M620 320 L540 450" />
  <path class="arrow" d="M620 320 L840 450" />

  <!-- Footer note -->
  <text x="40" y="700" class="text">Generated diagram — use `docs/pipeline_flow.svg` for vector editing and export to PNG for presentations.</text>
</svg>
