<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1000" height="900" viewBox="0 0 1000 900">
  <style>
    .box { fill:#fffaf0; stroke:#7a4a1c; stroke-width:2; rx:6 }
    .box-strong { fill:#fff4e6; stroke:#5a3518; stroke-width:2.5; rx:8 }
    .text { font-family: Helvetica, Arial, sans-serif; font-size:12px; fill:#2b2b2b }
    .title { font-weight:700; font-size:14px }
    .arrow { stroke:#5a3518; stroke-width:2; fill:none; marker-end:url(#a) }
  </style>

  <defs>
    <marker id="a" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#5a3518" />
    </marker>
  </defs>

  <text x="20" y="28" class="text title">Calling module — detailed flow (VarScan, Mutect2, Minos)</text>

  <!-- VarScan block -->
  <g transform="translate(40,60)">
    <rect class="box-strong" x="0" y="0" width="420" height="120" />
    <text x="12" y="22" class="text" style="font-weight:700">VarScan path</text>
    <text x="12" y="44" class="text">1) MAPQ60 filter → {prefix}_mapq60.sort.bam</text>
    <text x="12" y="62" class="text">2) samtools mpileup → {prefix}.mpileup.remove</text>
    <text x="12" y="80" class="text">3) VarScan pileup2snp → {prefix}.snp (renamed to {prefix}.snp.varscan)</text>
    <text x="12" y="98" class="text">4) converted VCF → {prefix}.parsed.vcf</text>
  </g>

  <!-- Mutect2 block -->
  <g transform="translate(520,60)">
    <rect class="box-strong" x="0" y="0" width="420" height="160" />
    <text x="12" y="22" class="text" style="font-weight:700">Mutect2 path</text>
    <text x="12" y="44" class="text">1) gatk Mutect2 → {prefix}_unfiltered.vcf</text>
    <text x="12" y="62" class="text">2) LearnReadOrientationModel / FilterMutectCalls → {prefix}.vcf → {prefix}_no_orientation.vcf</text>
    <text x="12" y="80" class="text">3) SelectVariants → {prefix}.indel.vcf and {prefix}.snp.vcf</text>
    <text x="12" y="98" class="text">4) indel cleanup → {prefix}.remade.indel.vcf</text>
    <text x="12" y="116" class="text">5) produce gVCF → {prefix}.gvcf (kept only with --keep_gvcf)</text>
  </g>

  <!-- arrows between VarScan and Mutect2 to Minos -->
  <path class="arrow" d="M460 120 L520 120" />

  <!-- Minos block -->
  <g transform="translate(260,220)">
    <rect class="box" x="0" y="0" width="490" height="120" />
    <text x="12" y="22" class="text" style="font-weight:700">Minos adjudication</text>
    <text x="12" y="44" class="text">singularity exec minos adjudicate --reads ... {prefix}_minos/</text>
    <text x="12" y="64" class="text">extract non-WT → {prefix}.final_sin_wt.vcf (then removed)</text>
    <text x="12" y="84" class="text">annotate with snpEff → {prefix}.final_sin_wt.annotSnpEff.vcf (when reference is MTB_anc/H37Rv)</text>
  </g>

  <path class="arrow" d="M500 180 L500 220" />

  <!-- Tabulation and filtering -->
  <g transform="translate(40,360)">
    <rect class="box" x="0" y="0" width="420" height="160" />
    <text x="12" y="22" class="text" style="font-weight:700">Tabulation & Minos raw table</text>
    <text x="12" y="44" class="text">minos_raw_vcf_to_tab() → {prefix}.minos.raw.tab</text>
    <text x="12" y="64" class="text">filter_raw_minos() → {prefix}.filtered.minos.raw.tab</text>
    <text x="12" y="84" class="text">rename → {prefix}.snp.minos</text>
    <text x="12" y="104" class="text">filter_EPI() → {prefix}.EPI.snp.nodensityfilter → densityfilter() → {prefix}.EPI.snp.final.annoF</text>
  </g>

  <g transform="translate(520,360)">
    <rect class="box" x="0" y="0" width="420" height="160" />
    <text x="12" y="22" class="text" style="font-weight:700">DR extraction & correction</text>
    <text x="12" y="44" class="text">get_DR() reads {prefix}.filtered.minos.raw.tab → {prefix}.DR.snp.final</text>
    <text x="12" y="64" class="text">CorrectDR() handles triallelic/double/triple codons</text>
    <text x="12" y="84" class="text">Produces {prefix}.lowcov and {prefix}.wt</text>
  </g>

  <!-- Cleanup block -->
  <g transform="translate(160,560)">
    <rect class="box-strong" x="0" y="0" width="680" height="160" />
    <text x="12" y="26" class="text" style="font-weight:700">Cleanup & renames (final step)</text>
    <text x="12" y="46" class="text">Removes: {prefix}.EPI.snp.nodensityfilter, {prefix}.final_sin_wt.vcf, {prefix}.lowcov.tsv,</text>
    <text x="12" y="66" class="text">{prefix}.minos.raw.tab, {prefix}.parsed.vcf, {prefix}.snp.vcf, {prefix}.vcf,</text>
    <text x="12" y="86" class="text">{prefix}_mapq60.sort.bam, {prefix}_no_orientation.vcf, {prefix}_unfiltered.vcf, {prefix}_unfiltered.vcf.stats</text>
    <text x="12" y="106" class="text">Renames: {prefix}.remade.snp.vcf → {prefix}.snp.mutect, {prefix}.snp → {prefix}.snp.varscan</text>
    <text x="12" y="126" class="text">(See calling cleanup block in `PipeModules/Calling.py` for exact list)</text>
  </g>

  <text x="20" y="860" class="text">SVG diagram — `docs/calling_flow.svg`. Convert to PNG locally or ask me to attempt conversion.</text>
</svg>
